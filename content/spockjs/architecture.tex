\section{Architecture}
Although the entire codebase of spockjs resides in
a single source code repository (\textit{monorepo}),
it is organized in and distributed as various packages
on the \textit{npm (Node.js package manager)} registry,
\autocite{Npm}
the de facto standard place for publishing JavaScript code.
The packages are all published in the \textit{@spockjs} namespace.
We have already seen two of these packages:
\textit{@spockjs/babel-plugin-spock} and \textit{@spockjs/assertion-block}.
There are a total of nine packages,
and we will add some more when implementing interaction testing.

Inside the repository, a package \textit{@spockjs/name}
is located in a \textit{packages/name} directory.
The `workspaces' feature \autocite{YarnWorkspacesDoc}
of the package manager \textit{Yarn}
links them all together during development
so changes across multiple packages do not require
first publishing the changes to a dependency
before working on the changes to a dependent.
In addition, the tool \textit{Lerna} \autocite{LernaGithub} is used to
perform tasks such as builds, changelog generation, version bumps, and releases
on multiple packages at once.

\paragraph{Presets}
The spockjs \textit{preset} system is a particularly useful application
for the multi-package architecture.
We have already mentioned the \code{presets} configuration option briefly.
A preset is a package that exports an arbitrary number of \textit{hooks}
that can tap into the process of transformation and perform additional manipulations.
The presets specified in the configuration will be dynamically imported during compilation.
This split also has the effect that users who add \textit{@spockjs/babel-plugin-spock}
as a dependency will only receive the few core packages of spockjs;
if they want additional features, they can seperately install packages like
\textit{@spockjs/preset-runner-jest} and add them to the presets array.

The \textit{@spockjs/preset-runner-jest} preset, for example, improves the experience
for developers that use spockjs with the Jest test runner.
Jest reports \code{AssertionError}s in tests uniquely by printing
some additional information based on the assert function.
Unfortunately, this information is confusing for users of spockjs,
who never wrote an assert function call, because it was generated for them behind the scenes.
To make Jest print only the error message supplied by spockjs,
the preset exports the \textit{@spockjs/assertion-post-processor-regular-errors} hook,
which wraps the assertion in a try-catch block that catches the \code{AssertionError}
and rethrows a regular \code{Error}:
\begin{minted}[linenos]{javascript}
try {
  assert(true);
} catch(e) {
  if (e instanceof AssertionError) {
    throw new Error(e.message);
  }
  throw e;
}
\end{minted}

While implementing interaction testing,
we will make further use of the preset mechanism
to let users specify the mocking library to be used
in the code generated by spockjs.
